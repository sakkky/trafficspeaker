<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>首都圏渋滞情報</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { width:100%; height:70%; }
  #controls { padding: 10px; text-align:center; }
  button { font-size: 1.2em; margin:5px; padding:10px 20px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <button id="start">読み上げ開始</button>
  <button id="stop">停止</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_URL = "https://weathered-snow-6ea6.sakky-tk.workers.dev/";

let map = L.map('map').setView([35.6895, 139.6917], 9); // 東京中心

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let trafficLayers = [];

async function loadTraffic() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    
    // 既存の渋滞レイヤーを削除
    trafficLayers.forEach(layer => map.removeLayer(layer));
    trafficLayers = [];

    data.messages.forEach((msg, i) => {
      if (!data[i]?.coords) return;

      const coords = data[i].coords.map(c => [c[0], c[1]]);
      const poly = L.polyline(coords, {color:'red', weight:5}).addTo(map);
      trafficLayers.push(poly);
    });

    return data;
  } catch(e) {
    console.error("渋滞情報取得エラー:", e);
    return { messages: [] };
  }
}

let utterance;
document.getElementById("start").addEventListener("click", async () => {
  const data = await loadTraffic();
  if (!data.messages.length) {
    alert("現在渋滞情報はありません。");
    return;
  }

  // ラジオ風文章を作成
  const text = data.messages.map(m => m).join("。次は、");
  utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "ja-JP";
  speechSynthesis.speak(utterance);
});

document.getElementById("stop").addEventListener("click", () => {
  speechSynthesis.cancel();
});
</script>

</body>
</html>