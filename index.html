<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>首都圏渋滞スピーカー</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#f5f5f5; }
#map { height:60vh; width:100%; }
#panel { background:white; padding:15px; border-top:1px solid #ccc; }
button { width:100%; padding:14px; font-size:18px; border-radius:8px; border:none; cursor:pointer; }
#startBtn { background:#007bff; color:white; }
#stopBtn { background:#888; color:white; margin-top:10px; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
<h2>首都圏 渋滞スピーカー</h2>
<p>「読み上げ開始」を押すと、渋滞情報を読み上げます。</p>
<button id="startBtn">読み上げ開始</button>
<button id="stopBtn">停止</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// iOS 対応のための“初回許可”フラグ
let iosUnlocked = false;

// JSONファイルの URL（GitHub Pages）
const JAM_JSON_URL = "https://sakkky.github.io/trafficspeaker/jams.json";

// --- 地図セットアップ ---
const map = L.map('map').setView([35.68, 139.76], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18 }).addTo(map);
let trafficLayer = L.layerGroup().addTo(map);

let intervalId = null;

// --- 渋滞情報取得＆読み上げ ---
async function readTraffic(){
    try{
        const res = await fetch(JAM_JSON_URL + "?" + Date.now());
        const data = await res.json();

        trafficLayer.clearLayers();
        let text = "";

        if(data.length === 0){
            text = "現在、登録されている渋滞情報はありません。";
        } else {
            data.forEach(j => {
                text += `${j.highway}は、${j.detail}。`;

                if(j.coords && j.coords.length > 1){
                    L.polyline(j.coords, { color:"red", weight:6 }).addTo(trafficLayer);
                }
            });
        }

        // 読み上げ
        const ut = new SpeechSynthesisUtterance(text);
        ut.rate = 1;
        speechSynthesis.speak(ut);

    } catch(err) {
        speechSynthesis.speak(new SpeechSynthesisUtterance("渋滞情報の取得に失敗しました。"));
        console.error(err);
    }
}

// --- ボタン操作 ---
document.getElementById("startBtn").onclick = () => {

    // ★ iPhone用初回解禁ダミー音声（最重要）
    if(!iosUnlocked){
        const dummy = new SpeechSynthesisUtterance("読み上げを開始します");
        dummy.rate = 1;
        speechSynthesis.speak(dummy);
        iosUnlocked = true;
    }

    // 最新データ読み上げ
    readTraffic();

    // 5分ごと
    if(intervalId) clearInterval(intervalId);
    intervalId = setInterval(readTraffic, 300000);
};

document.getElementById("stopBtn").onclick = () => {
    speechSynthesis.cancel();
    if(intervalId) clearInterval(intervalId);
};
</script>
</body>
</html>