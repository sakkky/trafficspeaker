<script>
// iOS 対応のための“初回許可”フラグ
let iosUnlocked = false;

// JSON の絶対パス
const JAM_JSON_URL = "https://sakkky.github.io/trafficspeaker/jams.json";

const map = L.map('map').setView([35.68, 139.76], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:18 }).addTo(map);
let trafficLayer = L.layerGroup().addTo(map);

let intervalId = null;

// --- 渋滞情報取得＆読み上げ ---
async function readTraffic(){
    try{
        const res = await fetch(JAM_JSON_URL + "?" + Date.now());
        const data = await res.json();

        trafficLayer.clearLayers();
        let text = "";

        if(data.length === 0){
            text = "現在、登録されている渋滞情報はありません。";
        } else {
            data.forEach(j => {
                text += `${j.highway}は、${j.detail}。`;

                if(j.coords && j.coords.length > 1){
                    L.polyline(j.coords,{color:"red", weight:6}).addTo(trafficLayer);
                }
            });
        }

        if(text){
            const ut = new SpeechSynthesisUtterance(text);
            ut.rate = 1;
            speechSynthesis.speak(ut);
        }

    }catch(err){
        console.error(err);
        speechSynthesis.speak(new SpeechSynthesisUtterance("渋滞情報の取得に失敗しました。"));
    }
}

// --- ボタン押下時 ---
document.getElementById("startBtn").onclick = () => {

    // ★ iPhone での音声許可を確実に取る（最重要）
    if(!iosUnlocked){
        const dummy = new SpeechSynthesisUtterance("読み上げを開始します");
        dummy.rate = 1;
        speechSynthesis.speak(dummy);
        iosUnlocked = true;
    }

    // すぐ最新を読み上げ
    readTraffic();

    // 5分ごと自動読み上げ
    if(intervalId) clearInterval(intervalId);
    intervalId = setInterval(readTraffic, 300000);
};

document.getElementById("stopBtn").onclick = () => {
    speechSynthesis.cancel();
    if(intervalId) clearInterval(intervalId);
};
</script>